{% extends "base.html" %}
{% block content %}
<h1 class="h1">–î–æ—Å–∫–∞</h1>
<form method="get" class="toolbar">
  <input type="text" class="input" name="q" placeholder="–ü–æ–∏—Å–∫..." value="{{ q }}">
  <select name="sort" class="input">
    <option value="">–ü–æ—Ä—è–¥–æ–∫ (—Ä—É—á–Ω–æ–π)</option>
    <option value="priority_desc" {% if sort=='priority_desc' %}selected{% endif %}>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Üì</option>
    <option value="priority_asc" {% if sort=='priority_asc' %}selected{% endif %}>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Üë</option>
    <option value="title" {% if sort=='title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏–µ A‚ÜíZ</option>
  </select>
  <button class="btn">–ù–∞–π—Ç–∏</button>
</form>
<div class="table-wrap">
<table class="table board-table" id="board">
  <colgroup><col class="col-title"><col class="col-prio"><col class="col-stage"><col class="col-stage"><col class="col-stage"><col class="col-stage"><col class="col-actions"></colgroup>
  <thead><tr><th>–ó–∞–¥–∞—á–∞</th><th class="prio-col">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>{% for st in STAGES %}<th>{{ st }}</th>{% endfor %}<th class="actions-col"></th></tr></thead>
  <tbody>
  {% for t in tasks %}
    <tr data-id="{{ t.id }}">
      <td><div class="title"><a href="/task/{{ t.id }}/jira" class="task-link">{{ t.title[:80] }}{% if t.title|length>80 %}‚Ä¶{% endif %}</a></div>{% if t.details %}<div class="muted">{{ t.details }}</div>{% endif %}</td>
      <td><span class="badge">{{ '–≤—ã—Å–æ–∫–∏–π' if t.priority==3 else '—Å—Ä–µ–¥–Ω–∏–π' if t.priority==2 else '–Ω–∏–∑–∫–∏–π' }}</span></td>
      {% for st in STAGES %}
      {% set color = (t.dev_color if st=='DEV' else t.demo_color if st=='DEMO' else t.lt_color if st=='LT' else t.prod_color) %}
      <td class="stage {{ color }}">
        <div class="stage-status muted">{{ t.dev_status if st=='DEV' else t.demo_status if st=='DEMO' else t.lt_status if st=='LT' else t.prod_status }}</div>
        {% set items = t.assignments | selectattr('stage','equalto', st) | list %}
        {% if items %}
          <ul class="tight people-list">
            {% for a in items %}
              <li class="person-chip" data-comment="{{ a.comment|e }}"><span class="chip">{{ a.person.name }}</span></li>
            {% endfor %}
          </ul>
        {% else %}<span class="muted">‚Äî</span>{% endif %}
      </td>
      {% endfor %}
      <td class="actions-cell">
        <a class="icon-btn" href="/task/{{ t.id }}/edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
        <form method="post" action="/task/{{ t.id }}/delete" style="display:inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')"><button class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button></form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>
<script>
(function(){
  const tbody = document.querySelector("#board tbody"); if(!tbody) return;
  let dragEl = null;
  tbody.querySelectorAll("tr").forEach(tr => {
    tr.draggable = true;
    tr.addEventListener("dragstart", e => { dragEl = tr; tr.classList.add("dragging"); });
    tr.addEventListener("dragend", async e => {
      tr.classList.remove("dragging"); dragEl=null;
      const ids = Array.from(tbody.querySelectorAll('tr[data-id]')).map(x=>x.dataset.id);
      try{ await fetch('/api/tasks/reorder',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids})}); showToast('‚úî –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }catch(e){ showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
    });
    tr.addEventListener("dragover", e => {
      e.preventDefault();
      const target = e.currentTarget;
      if (!dragEl || target===dragEl) return;
      const rect = target.getBoundingClientRect();
      const after = (e.clientY - rect.top) > (rect.height/2);
      tbody.insertBefore(dragEl, after ? target.nextSibling : target);
    });
  });
})();
function bindTooltips(){
  let tip = document.getElementById('hover-tip');
  if(!tip){
    tip = document.createElement('div'); tip.id='hover-tip'; tip.className='bubble-tip';
    const arrow = document.createElement('div'); arrow.className='bubble-arrow'; tip.appendChild(arrow);
    const body = document.createElement('div'); body.className='bubble-body'; tip.appendChild(body);
    document.body.appendChild(tip);
  }
  const body = tip.querySelector('.bubble-body');
  function show(el){
    const c = el.getAttribute('data-comment'); if(!c){ hide(); return; }
    body.textContent = c;
    tip.style.display='block';
    tip.style.opacity='0'; tip.style.transform='translateY(-6px)';
    // place at top-right of chip
    const r = el.getBoundingClientRect();
    // first position roughly, then measure and correct
    tip.style.left = (r.right + 10) + 'px';
    tip.style.top = (r.top - 10) + 'px';
    // measure
    const w = tip.offsetWidth, h = tip.offsetHeight;
    let x = r.right + 10;
    let y = r.top + (r.height - h)/2;
    if (x + w + 8 > window.innerWidth) x = window.innerWidth - w - 8;
    if (y < 8) y = 8;
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';
    // animate in
    requestAnimationFrame(()=>{ tip.style.opacity='1'; tip.style.transform='translateY(0)'; });
  }
  function hide(){ tip.style.display='none'; }
  document.querySelectorAll('.person-chip').forEach(el=>{
    el.addEventListener('mouseenter', ()=> show(el));
    el.addEventListener('mouseleave', hide);
  });
}
window.addEventListener('load', bindTooltips);
</script>
{% endblock %}
